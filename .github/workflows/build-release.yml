name: Build Release Binaries

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., v1.8.4). Tag v1.8.4-custom will be checked out.'
        required: true
        default: 'v1.8.4'

env:
  BUILD_TYPE: Release
  TAG_NAME: ${{ github.event.inputs.version }}-custom

jobs:
  linux-x86_64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          cmake --build build --config ${{ env.BUILD_TYPE }} -j $(nproc)

      - name: Package
        run: |
          mkdir -p release
          cp build/bin/whisper-cli release/
          cp build/bin/whisper-server release/ || true
          cp build/src/libwhisper.so release/ || true
          tar -czvf whisper-linux-x86_64.tar.gz -C release .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-linux-x86_64
          path: whisper-linux-x86_64.tar.gz

  linux-arm64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build in ARM64 container
        run: |
          docker run --platform linux/arm64 --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace ubuntu:22.04 /bin/bash -c '
            set -e
            apt-get update
            apt-get install -y build-essential cmake
            cmake -B build -DCMAKE_BUILD_TYPE=Release -DGGML_NATIVE=OFF -DGGML_CPU_ARM_ARCH=armv8-a
            cmake --build build --config Release -j $(nproc)
            mkdir -p release
            cp build/bin/whisper-cli release/ || true
            cp build/bin/whisper-server release/ || true
            cp build/src/libwhisper.so release/ || true
            '

      - name: Package
        run: |
          tar -czvf whisper-linux-arm64.tar.gz -C release .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-linux-arm64
          path: whisper-linux-arm64.tar.gz

  macos-x86_64:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}

      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DGGML_METAL=OFF \
            -DGGML_NATIVE=OFF
          cmake --build build --config ${{ env.BUILD_TYPE }} -j $(sysctl -n hw.logicalcpu)

      - name: Package
        run: |
          mkdir -p release
          cp build/bin/whisper-cli release/
          cp build/bin/whisper-server release/ || true
          cp build/src/libwhisper.dylib release/ || true
          tar -czvf whisper-macos-x86_64.tar.gz -C release .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-macos-x86_64
          path: whisper-macos-x86_64.tar.gz

  macos-arm64:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}

      - name: Build
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DGGML_METAL=ON \
            -DGGML_METAL_EMBED_LIBRARY=ON
          cmake --build build --config ${{ env.BUILD_TYPE }} -j $(sysctl -n hw.logicalcpu)

      - name: Package
        run: |
          mkdir -p release
          cp build/bin/whisper-cli release/
          cp build/bin/whisper-server release/ || true
          cp build/src/libwhisper.dylib release/ || true
          cp build/bin/ggml-metal.metal release/ || true
          tar -czvf whisper-macos-arm64.tar.gz -C release .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-macos-arm64
          path: whisper-macos-arm64.tar.gz

  windows-x86_64:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG_NAME }}

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          cmake --build build --config ${{ env.BUILD_TYPE }} -j $env:NUMBER_OF_PROCESSORS

      - name: Package
        run: |
          New-Item -ItemType Directory -Force -Path release
          Copy-Item build\bin\${{ env.BUILD_TYPE }}\whisper-cli.exe release\ -ErrorAction SilentlyContinue
          Copy-Item build\bin\${{ env.BUILD_TYPE }}\whisper-server.exe release\ -ErrorAction SilentlyContinue
          Copy-Item build\bin\${{ env.BUILD_TYPE }}\whisper.dll release\ -ErrorAction SilentlyContinue
          Copy-Item build\bin\${{ env.BUILD_TYPE }}\ggml.dll release\ -ErrorAction SilentlyContinue
          Copy-Item build\bin\${{ env.BUILD_TYPE }}\ggml-base.dll release\ -ErrorAction SilentlyContinue
          Copy-Item build\bin\${{ env.BUILD_TYPE }}\ggml-cpu.dll release\ -ErrorAction SilentlyContinue
          Compress-Archive -Path release\* -DestinationPath whisper-windows-x86_64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-windows-x86_64
          path: whisper-windows-x86_64.zip

  release:
    needs: [linux-x86_64, linux-arm64, macos-x86_64, macos-arm64, windows-x86_64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}-custom
          name: whisper.cpp ${{ github.event.inputs.version }} (Custom Build)
          body: |
            Custom build of whisper.cpp ${{ github.event.inputs.version }}

            ## Included platforms
            - Linux x86_64
            - Linux arm64
            - macOS x86_64 (Intel)
            - macOS arm64 (Apple Silicon, with Metal support)
            - Windows x86_64

            ## Contents
            Each archive contains:
            - `whisper-cli` - Command line tool
            - `whisper-server` - HTTP server
            - `libwhisper.so/.dylib` - Shared library
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          draft: false
          prerelease: false
